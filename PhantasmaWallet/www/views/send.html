{{#if holdings}}

<!--<div class="form-group">
    <h4 class="tab-title">Pick a chain:</h4>
    <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle btn-asset-no-border" data-toggle="dropdown">
            Chain <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
            {{#each availableChains}}
            <li>
                <a class="dropdown-item" href="#" onclick="pickChain('{{this}}')">{{this}}</a>
            </li>
            {{/each}}
        </ul>
    </div>
    <span id="selectedChain"></span>
</div>-->

<div class="container">
    <div class="stepwizard">
        <div class="stepwizard-row setup-panel">
            <div class="stepwizard-step">
                <a href="#step-1" type="button" class="btn btn-primary btn-circle">1</a>
                <p>Step 1</p>
            </div>
            <div class="stepwizard-step">
                <a href="#step-2" type="button" class="btn btn-default btn-circle" disabled="disabled">2</a>
                <p>Step 2</p>
            </div>
            <div class="stepwizard-step">
                <a href="#step-3" type="button" class="btn btn-default btn-circle" disabled="disabled">3</a>
                <p>Step 3</p>
            </div>
        </div>
    </div>
    <form role="form">
        <div class="row setup-content" id="step-1">
            <div class="col-xs-12">
                <div class="col-md-12">
                    <h3>Select chain</h3>
                    <div class="form-group">
                        <select class="form-control" id="selectChain">
                            {{#each availableChains}}
                            <option>{{this}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <button class="btn btn-primary nextBtn btn-lg pull-right" type="button">Next</button>
                </div>
            </div>
        </div>
        <div class="row setup-content" id="step-2">
            <div class="col-xs-12">
                <div class="col-md-12">
                    <h3> Select Token</h3>
                    <div class="form-group">
                        <select class="form-control" id="selectToken">
                            {{#each holdings}}
                            <option><a class="dropdown-item" href="#" onclick="pickToken('{{name}}', '{{symbol}}', '{{icon}}', '{{amount}}')"><img class="token-icon" src="img/{{icon}}.png" />{{name}}</a></option>
                            {{/each}}
                        </select>
                    </div>
                    <button class="btn btn-primary nextBtn btn-lg pull-right" type="button">Next</button>
                </div>
            </div>
        </div>
        <div class="row setup-content" id="step-3">
            <div class="col-xs-12">
                <div class="col-md-12">
                    <h3> Step 3</h3>
                    <button class="btn btn-success btn-lg pull-right" type="submit">Finish!</button>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="form-group" id="asset_form">
    <h4 class="tab-title" id="title">Pick an asset:</h4>
    <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle btn-asset-no-border" data-toggle="dropdown">
            Asset <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
            {{#each holdings}}
            <li>
                <a class="dropdown-item" href="#" onclick="pickToken('{{name}}', '{{symbol}}', '{{icon}}', '{{amount}}')"><img class="token-icon" src="img/{{icon}}.png" />{{name}}</a>
            </li>
            {{/each}}
        </ul>
    </div>
</div>
<br />
<h2 class="tab-title" id="token-description"></h2>
<h2 class="tab-title" id="chain-description"></h2>

<div id="send_form">
    <div class="form-group input-group borderless-input">
        <span class="input-group-addon borderless-input" id="token-symbol" style="color: #7C95AB; font-size: 14px;"> ???</span>
        <input type="number" class="form-control borderless-input token-shadow" placeholder="Amount" id="amount">
    </div>
    <div class="form-group">
        <button type="button" class="btn btn-primary pull-right btn-normal" onclick="pickMax()">Max Amount</button>
        <br>
    </div>
    <br />
    <br />
    <br />
    <div class="form-group">
        <input type="text" class="form-control borderless-input shadow-box" placeholder="Destination" id="destination">
    </div>

    <div class="form-group">
        <button type="button" class="btn btn-primary pull-right btn-normal" data-toggle="modal" data-target="#scanModal">Scan</button>
        <br>
    </div>
    <br />
    <div class="form-group">
        <br>
        <div class="col-sm-12 text-center">
            <button type="button" class="btn btn-primary btn-lg btn-normal" style="width: 200px" onclick="confirmSend()">Send</button>
        </div>
        <br>
    </div>

</div>

<!-- Modal -->
<div id="scanModal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Address Scanner</h4>
            </div>
            <div class="modal-body">
                <p>Scan a valid Phantasma QR code.</p>
                <video id="preview"></video>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>

<script>
    var form_visible = false;
    var asset_visible = true;
    var selected_chain = null;
    var selected_name = null;
    var selected_symbol = null;
    var max_amount = 0;

    $("#send_form").hide();
    //$("#asset_form").hide();


    $('#scanModal').on('shown.bs.modal',
        function(e) {
            startScan();
        })

    function stopScan(scanner) {
        scanner.stop();
        $('#scanModal').modal('hide');
    }

    function startScan() {
        let tag = "phantasma://";
        let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });

        scanner.addListener('scan',
            function(content) {
                if (content.startsWith(tag)) {
                    var address = content.substring(tag.length);
                    $("#destination").val(address);
                } else {
                    bootbox.alert("A QR code was read but does not seem to be a valid Phantasma QR code.");
                }

                stopScan(scanner);
            });

        Instascan.Camera.getCameras().then(function(cameras) {
            if (cameras.length > 0) {
                scanner.start(cameras[0]);
            } else {
                bootbox.alert("Sorry, camera not found.");
                $('#scanModal').modal('hide');

                return;
            }
        }).catch(function(e) {
            console.error(e);
        });
    }

    function pickChain(name) {
        selected_chain = name;
        if (!asset_visible) {
            asset_visible = true;
            $("#asset_form").fadeIn();
        }

        $("#chain-description").html(selected_chain + " chain");

    }

    function pickToken(name, symbol, icon, amount) {
        selected_name = name;
        selected_symbol = symbol;
        max_amount = amount;

        $("#token-description").html("<img src='img/" + icon + ".png' class='token-icon'/>" + name + " transfer");
        $("#token-symbol").html(symbol);

        if (!form_visible) {
            form_visible = true;
            $("#send_form").fadeIn();
        }
    }

    function pickMax() {
        $("#amount").val(max_amount);
    }

    function confirmSend() {
        let amount = $("#amount").val();
        let target_address = $("#destination").val();

        if (amount <= 0) {
            bootbox.alert("Please insert a valid amount!");
            return;
        }

        if (target_address.length == 0) {
            bootbox.alert("Please insert an destination address!");
            return;
        }

        if (target_address.length != 45) {
            bootbox.alert("Please insert a valid destination address!");
            return;
        }

        if (target_address == '{{address}}') {
            bootbox.alert("The destination address cannot be the same as your own address!");
            return;
        }

        bootbox.confirm({
            title: "Transfer confirmation",
            message: "Send <strong>" +
                amount +
                " " +
                selected_symbol +
                "</strong> to address <strong>" +
                target_address +
                "</strong>?",
            buttons: {
                cancel: {
                    label: '<i class="fa fa-times"></i> Cancel'
                },
                confirm: {
                    label: '<i class="fa fa-check"></i> Confirm'
                }
            },
            callback: function(result) {

                if (result) {
                    console.log('This was logged in the callback: ' + result);

                    var symbol = document.getElementById("token-symbol").innerText;
                    var amount = document.getElementById("amount");
                    var addressTo = document.getElementById("destination");


                    window.location.replace("/sendrawtx?" +
                        "token=" +
                        symbol +
                        "&amount=" +
                        amount.value +
                        "&dest=" +
                        addressTo.value +
                        "&chain=" + selected_chain);
                }
            }
        });
    }

    $(document).ready(function () {

        var navListItems = $('div.setup-panel div a'),
            allWells = $('.setup-content'),
            allNextBtn = $('.nextBtn');

        allWells.hide();

        navListItems.click(function (e) {
            e.preventDefault();
            var $target = $($(this).attr('href')),
                $item = $(this);

            if (!$item.hasClass('disabled')) {
                navListItems.removeClass('btn-primary').addClass('btn-default');
                $item.addClass('btn-primary');
                allWells.hide();
                $target.show();
                $target.find('input:eq(0)').focus();
            }
        });

        allNextBtn.click(function(){
            var curStep = $(this).closest(".setup-content"),
                curStepBtn = curStep.attr("id"),
                nextStepWizard = $('div.setup-panel div a[href="#' + curStepBtn + '"]').parent().next().children("a"),
                curInputs = curStep.find("input[type='text'],input[type='url']"),
                isValid = true;

            $(".form-group").removeClass("has-error");
            for(var i=0; i<curInputs.length; i++){
                if (!curInputs[i].validity.valid){
                    isValid = false;
                    $(curInputs[i]).closest(".form-group").addClass("has-error");
                }
            }

            if (isValid)
                nextStepWizard.removeAttr('disabled').trigger('click');
        });

        $('div.setup-panel div a.btn-primary').trigger('click');
    });

    $("#selectChain").on("change",
        function (e, clickedIndex, newValue, oldValue) {
            selected_chain = this.value;
            console.log(this.value);
        });

</script>
{{#else}}
<h4 class="tab-title">Not assets available</h4>
<div class="alert alert-info" role="alert">
    This address is still new and does not have any assets yet.
</div>
{{/if}}